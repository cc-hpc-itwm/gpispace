#!/bin/bash
#
#  this file is supposed to be sourced:
#
#    . $(gspc --exec-path)/gspc-sh-setup
#

################################################################################
#                                                                              #
#                        Log functions                                         #
#                                                                              #
################################################################################

function gspc_is_verbose_enabled ()
{
    local level=1
    if [ -n "$1" ] ; then
        level="$1"
    fi

    if [ -n "$GSPC_VERBOSE" ]
    then
        if [ $GSPC_VERBOSE -ge $level ]
        then
            return 0
        fi
    fi
    return 1
}

function gspc_isatty()
{
    local fd="$1" ; shift
    if readlink -f "/proc/$$/fd/$fd" | grep -q pts ; then
        return 0
    else
        return 1
    fi
}

function gspc_is_a_human_watching ()
{
    if gspc_isatty 1 ; then
        return 0
    else
        return 1
    fi
}

function gspc_log_impl ()
{
    local level="$1"; shift
    local component="$1" ; shift

    level_id='T'
    s_color=""
    e_color=""

    # see gspc-config why this guard has been placed here
    if [ -z "$GSPC_LOG_FROM_CONFIG" ] ; then
        color_mode=$(gspc config --global --get color.log)
        if [ -n "$color_mode" -a "$color_mode" != "off" ] ; then
            if gspc_isatty 2 ; then
                color_mode=on
            else
                color_mode=off
            fi
        fi
    fi

    if [ "$color_mode" = "on" ]
    then
        color_black="\e[0;30m"
        color_red="\e[0;31m"
        color_green="\e[0;32m"
        color_yellow="\e[0;33m"
        color_blue="\e[0;34m"
        color_purple="\e[0;35m"
        color_cyan="\e[0;36m"
        color_white="\e[0;37m"
        e_color='\e[0m'
    fi

    case "$level" in
        trace)
            s_color=""
            level_id=T
            ;;
        debug)
            s_color=""
            level_id=D
            ;;
        info)
            s_color=""
            level_id=I
            ;;
        warn)
            s_color="$color_yellow"
            level_id=W
            ;;
        error)
            s_color="$color_red"
            level_id=E
            ;;
        *)
            s_color=""
            ;;
    esac
    echo -e >&2 "${s_color}[${level_id}] ($component): $@${e_color}"
}

function gspc_log_trace ()
{
    if gspc_is_verbose_enabled 3 ; then
        gspc_log_impl trace "$@"
    fi
}

function gspc_log_debug ()
{
    if gspc_is_verbose_enabled 2 ; then
        gspc_log_impl debug "$@"
    fi
}

function gspc_log_info ()
{
    if gspc_is_verbose_enabled 1 ; then
        gspc_log_impl info "$@"
    fi
}

function gspc_log_warn ()
{
    gspc_log_impl warn "$@"
}

function gspc_log_error ()
{
    gspc_log_impl error "$@"
}

################################################################################
#                                                                              #
#                        Utility functions                                     #
#                                                                              #
################################################################################

function gspc_abspath ()
{
    case "${1:0:1}" in
        /)
            echo "$1"
            ;;
        *)
            echo $(readlink -m "$PWD/$1")
            ;;
    esac
}

function gspc_call_editor ()
{
    local editor=()
    editor=( $(gspc config --get core.editor) )
    if [ $? -ne 0 -o -z "${editor}" ] ; then
        editor=("${EDITOR:=/usr/bin/vi}")
    fi
    "${editor[@]}" "$@"
}

function gspc_prepend_path ()
{
    local var="$1"; shift
    local val=$(eval echo \$${var})
    for v ; do
        val=$(echo "$val" | sed "s,:$v:,:,g")
        val=$(echo "$val" | sed -e "s,^$v:,,g")
        val=$(echo "$val" | sed -e "s,:$v\$,,g")
        val="$v:$val"
    done
    eval "$var=$val"
}

function gspc_require_gspc_dir ()
{
    if [ -z "$GSPC_DIR" ]
    then
        gspc_log_error core "GSPC_DIR is not set"
        exit 1
    fi

    if [ ! -d "$GSPC_DIR" ]
    then
        gspc_log_error core "GSPC_DIR ('$GSPC_DIR') is not accessible"
        exit 1
    fi

    return 0
}

function gspc_get_kvs_entry ()
{
    local key="$1"; shift
    local kvs_host=""
    local kvs_port=""

    kvs_host=$(gspc config --local --get kvs.host)
    if [ $? -ne 0 ] ; then
        return 1
    fi
    kvs_port=$(gspc config --local --get kvs.port)
    if [ $? -ne 0 ] ; then
        return 1
    fi

    fhgkvsc -H "$kvs_host" -P "$kvs_port" -g "$key" 2>/dev/null
}
