#!/bin/bash

function usage ()
{
    cat >&2 <<EOF
usage: $(basename "$0") [options]

    -h: print this help
    -i ident (=$identiy): identity
    -d: dry run
    -n: name prefix
    -p: pattern
    -v: be verbose
EOF
}

identity=
dry_run=false
name_prefix=''
pattern=
verbose=false

while getopts ":hi:dn:p:v" opt; do
    case $opt in
        h)
            usage
            exit 0
            ;;
        i)
            identity=$OPTARG
            ;;
        d)
            dry_run=true
            ;;
        n)
            name_prefix="$OPTARG"
            ;;
        p)
            pattern="$OPTARG"
            ;;
        v)
            verbose=true
            ;;
        \?)
            echo "invalid option: -$OPTARG" >&2
            echo "try: $0 -h" >&2
            exit 1
            ;;
    esac
done

function debug()
{
    $verbose && echo >&2 $@
}

function kill_drts ()
{
    local pid="$1" ; shift
    local name="$1" ; shift
    local alive=true
    echo -n "Terminating $pid..."
    for (( i=0; i < 3; ++i )); do
        echo -n "."
        kill -TERM "$pid" >/dev/null 2>&1
        if [ $? -ne 0 ] ; then
            alive=false
        fi
        if [ "$alive" == "false" ] ; then
            echo "ok."
            return 0
        fi
        sleep 0.5
    done
    if [ "$alive" == "true" ] ; then
        echo "killed."
        kill -KILL "$pid" >/dev/null 2>&1
    fi
}

if [ -z "$pattern" ] ; then
    if [ -z "$name_prefix" ] ; then
        pattern=".*"
    else
        pattern="$name_prefix-$(hostname -s)"
    fi

    if [ -n "$identity" ] ; then
        pattern="$pattern-${identity}"
    else
        pattern="$pattern-[0-9]\+"
    fi
fi

debug "pattern = '$pattern'"

still_running=$(ps -C fhgkernel -o pid=)
for p in $still_running ; do
    name=$(cat /proc/$p/cmdline | tr '\0' ' ' |  grep -o 'plugin.drts.name=[^ ]\+' | cut -d= -f2)
    if [ -z "$name" ] ; then
        continue
    fi

    debug "found running drts: $name"

    if echo "$name" | grep -q "^${pattern}$" ; then
        if $dry_run ; then
            echo kill_drts "$p" "$name"
        else
            kill_drts "$p" "$name" >/dev/null 2>&1
        fi
    fi
done
wait
