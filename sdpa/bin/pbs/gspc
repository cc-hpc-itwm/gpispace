#!/bin/bash

mydir=$(dirname $(which "$0"))
exec_path=$(readlink -f "${mydir}/../libexec/sdpa/scripts")
verbose=0

. "${exec_path}/gspc-sh-version"
if [ $? -ne 0 ] ; then
    echo >&2 "Installation incomplete, please contact the admin!"
    exit 1
fi

. "${exec_path}/gspc-sh-setup"
if [ $? -ne 0 ] ; then
    echo >&2 "Installation incomplete, please contact the admin!"
    exit 1
fi

function usage()
{
    cat <<EOF
usage: $(basename $0) [-h|--help] [options] [--]
               <command> [<args>]

Options:

    -h|--help      : print usage information
    --version      : print the long version
    -v|--verbose   : verbosity level (specify multiple times)
    --dumpversion  : print the short version string
    --revision     : print the revision information

Environment information:

    --exec-path    : print the path to the helper scripts

Commands:

$(gspc list-commands --indent=4)
EOF
}
#   list-commands          : list all available commands
#   config                 : set/get config values
#   rexec <node> <command> : executes a command remotely

function _resolve_command_path ()
{
    local cmd_name="$1" ; shift
    echo "${exec_path}/gspc-${cmd_name}"
}

while true ; do
    case "$1" in
        --help) usage; exit 0 ;;
        --gspc-dir)
            if [ -z "$GSPC_DIR" ] ; then
                exit 1
            else
                echo "$GSPC_DIR"
                exit 0
            fi
            shift
            ;;
        --gspc-dir=*)
            dir=$(gspc_abspath "${1:11}")
            export GSPC_DIR="$dir"
            shift
            ;;
        --exec-path)
            if [ -z "$exec_path" ] ; then
                echo >&2 "could not deduce exec-path"
                exit 1
            fi
            echo "$exec_path"
            shift
            exit 0
            ;;
        --version)
            echo "GPI-Space ${GSPC_INFO_VERSION}"
            shift
            exit 0
            ;;
        --dumpversion)
            echo "${GSPC_INFO_VERSION}"
            shift
            exit 0
            ;;
        --revision)
            echo "${GSPC_INFO_REVISION}"
            shift
            exit 0
            ;;
        --verbose) verbose=$((verbose + 1)); shift ;;
        -[a-z]*)
            flags="${1:1}"
            while [ -n "$flags" ] ; do
                flag="${flags:0:1}"
                flags="${flags:1}"
                case "$flag" in
                    v) verbose=$((verbose+1)) ;;
                    h) usage ; exit 0 ;;
                    *)
                        echo >&2 "gspc: invalid flag: $flag"
                        exit 1
                        ;;
                esac
            done
            shift
            ;;
        --) shift; break ;;
        -*)
            echo >&2 "gspc: invalid option: $1"
            exit 1
            ;;
        *) break ;;
    esac
done

if [ -z "$1" ] ; then
    usage
    exit 1
fi

gspc_prepend_path PATH "${mydir}"

cmd_name="$1"; shift

cmd=( $("${exec_path}/gspc-config" --get "alias.${cmd_name}") )
if [ $? -eq 0 ] ; then
    cmd_name="${cmd[0]}"
fi

cmd[0]=$(_resolve_command_path "${cmd_name}")

if [ -x "${cmd[0]}" ] ; then
    GSPC_VERBOSE="${verbose}" "${cmd[@]}" "$@"
else
    echo >&2 "gspc: '$cmd_name' is not a GPI-Space command. See 'gspc --help'."
fi
