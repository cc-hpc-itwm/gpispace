#!/bin/bash
### avoid strange behaviour with temporary inconsistency
### on Panasas Filesystems:
###
###     the test -r was sucessful but the source didn't
###     source anything
###
###
debug=false
bind_addr='0'
name="orchestrator"
kvs_url=
daemonize=false
pidfile=
state_dir="$HOME/.sdpa/state"
config_file="$HOME/.sdpa/configs/sdpa.rc"
logdir=

while getopts ":hgn:l:d:k:DP:L:s:" opt; do
    case $opt in
        g)
            debug=true
            ;;
        l)
            bind_addr=$OPTARG
            ;;
        n)
            name=$OPTARG
            ;;
        k)
            kvs_url=$OPTARG
            ;;
        D)
            daemonize=true
            ;;
        P)
            pidfile=$OPTARG
            ;;
        L)
            logdir=$OPTARG
            ;;
        s)
            state_dir=$OPTARG
            ;;
        F)
            config_file="$OPTARG"
            ;;
        h)
            echo "usage: $0 [-h] [-g] [-l interface] [-n name] [-b backup-dir]" >&2
            echo "    -h : print this help" >&2
            echo "    -l : address to listen on (default: $bind_addr)" >&2
            echo "    -n : name (default: $name)" >&2
            echo "    -k : kvs url" >&2
            echo "    -g : run within gdb" >&2
            echo "    -D : daemonize" >&2
            echo "    -P pidfile: write pid to this file and lock it" >&2
            echo "    -s dir: sdpa state dir to use" >&2
            echo "    -F config file: path to the sdpa config" >&2
            exit 0
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            exit 1
    esac
done

if [ -r "${state_dir}/sdpa.env" ] ; then
    source "${state_dir}/sdpa.env"
else
    echo >&2 "needs to be executed under SDPA"
    exit 4
fi

if [ -z "$logdir" ]
then
    logdir="${state_dir}/log"
fi

logprefix="${logdir}/${name}"

if [ -z "$kvs_url" ]
then
    kvs_url="$KVS_URL"
fi

# check environment

if [ -z "$kvs_url" ]
then
    echo >&2 "E: kvs url was not specified!"
    exit 2
fi

log "Running $name at $bind_addr"

argv="$SDPA_HOME/bin/orchestrator -u $bind_addr -n ${name} -k ${kvs_url}"
stateful=$(fhgcfg -f "${config_file}" -g sdpa.stateful -v false)
if [ x"$stateful" = x"true" ] ; then
    bkp_dir="${state_dir}/orch"
    mkdir -p "${bkp_dir}"
    argv="$argv -d ${bkp_dir}"
fi
if $daemonize && ! $debug ; then
    argv="$argv --daemonize"
fi
if [ -n "$pidfile" ] ; then
    argv="$argv --pidfile $pidfile"
fi

if $debug ; then
    log "running within gdb..."
    FHGLOG_to_console="stderr" gdb -ex run --args $argv
else
    FHGLOG_to_file="${logprefix}.log" exec $argv >"${logprefix}.out" 2>"${logprefix}.err"
fi
