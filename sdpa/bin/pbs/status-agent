#!/bin/bash
name=
long=false

function usage ()
{
    cat >&2 <<EOF
usage: $(basename "$0") [options]

    -h: print this help
    -n name (*): name of the agent to check
                 if empty a list of all currently
                 running agents will be printed
    -l: print the whole command of the agent
EOF
}

while getopts ":hn:l" opt; do
    case $opt in
        h)
            usage
            exit 0
            ;;
        n)
            name=$OPTARG
            ;;
        l)
            long=true
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            exit 1
    esac
done

function agent_status ()
{
    local name="$1" ; shift
    local pids=
    pids=$(ps -C agent -o pid=)

    if [ -n "$name" ] ; then
        for p in $pids ; do
            agent_name=$(cat /proc/$p/cmdline | tr '\0' '\n' | grep -A1 -e '^-n$' | tail -n 1)
            if [ "$agent_name" = "$name" ] ; then
                echo "$p"
                return 0
            fi
        done
    fi

    if [ -z "$pids" ] ; then
        return 1
    else
        echo $pids
        return 0
    fi
}

pids=$(agent_status $name)
if [ -n "$pids" ] ; then
    if [ -n "$name" ] ; then
        echo "ok"
        exit 0
    else
        for p in $pids ; do
            cmd="$(ps -p $p -o cmd=)"
            if [ $long = false ] ; then
                cmd=$(echo $cmd | sed -e 's/.*-n \([^ ]\+\).*/\1/')
            fi
            echo "pid $p := $cmd"
        done
        exit 0
    fi
else
    exit 1
fi
