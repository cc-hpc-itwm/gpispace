#!/bin/bash

GSPC_DOC_SHORT_DESCRIPTION="execute commands remotely"
GSPC_IMPORTANT_API_COMMAND=true

. $(gspc --exec-path)/gspc-sh-setup

function usage ()
{
    cat >&2 <<EOF
usage: rexec host command [args...]
EOF
}

ssh_opts="-q -x -T -n -C -4 -c arcfour,blowfish-cbc -o CheckHostIP=no -o StrictHostKeyChecking=no"

node="${1}"; shift

if [ -z "$node" ] ; then
    usage
    exit 1
fi

if [ $# -eq 0 ] ; then
    usage
    exit 1
fi

gspc_log_trace rexec "$node $@"

if [ $(hostname -s) = "$node" ]
then
    /usr/bin/env PATH="$PATH" GSPC_DIR="$GSPC_DIR" "$@"
else
    gspc_log_trace rexec ssh $ssh_opts $node /usr/bin/env PATH="$PATH" GSPC_DIR="$GSPC_DIR" "$@"
    ssh $ssh_opts $node /usr/bin/env PATH="$PATH" GSPC_DIR="$GSPC_DIR" "$@"
fi
