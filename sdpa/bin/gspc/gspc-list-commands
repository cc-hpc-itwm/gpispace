#!/bin/bash

GSPC_API_COMMAND_SHORT_DESCRIPTION="list available GPI-Space commands"
GSPC_API_COMMAND_LEVEL=-1

. "${GSPC_EXEC_PATH}/gspc-sh-setup" || { echo >&2 "must be run by 'gspc'" ; exit 64; }

command_directory="${GSPC_EXEC_PATH}"

indent=0
level=1
only_important=true
only_names=false
prefix=""

while true ; do
    case "$1" in
        --indent=*)
            indent=$(( ${1:9} ))
            shift
            ;;
        --names-only)
            only_names=true
            shift
            ;;
        --all)
            only_important=false
            shift
            ;;
        --level=*)
            level=$(( ${1:8} ))
            shift
            ;;
        --prefix=*)
            prefix="${1:9}"
            if [ -n "$prefix" ]
            then
                prefix="${prefix}-"
            fi
            shift
            ;;
        -h|--help)
            echo >&2 "usage: list-commands [-h|--help] [--indent=N] [--all] [--names-only] [--prefix=<prefix>]"
            exit 0
            shift
            ;;
        --) shift ; break ;;
        *) break ;;
    esac
done

find "$command_directory" -name "gspc-${prefix}*" | sort -u | while read path ; do
    if [ -x "$path" ]
    then
        cmd_level=$(grep '^GSPC_API_COMMAND_LEVEL=' "$path" | cut -d= -f2 | xargs echo)
        if [ -z "$cmd_level" ]
        then
            cmd_level=-1
        fi

        if [ ! $only_important -a $cmd_level -eq -1 ]
        then
            continue
        fi

        if [ $cmd_level -gt $level ]
        then
            continue
        fi

        if ! $only_names ; then
            desc=$(grep '^GSPC_API_COMMAND_SHORT_DESCRIPTION=' "$path" | cut -d= -f2 | xargs echo)
        fi

        executable=$(basename $path)
        command=${executable:5}
        command=${command/$prefix/}

        if [ -n "$desc" ]
        then
            printf "%${indent}s%-20s %s\n" "" "${command}" "${desc}"
        else
            printf "%${indent}s%s\n" "" "${command}"
        fi
    fi
done
