#!/bin/bash

GSPC_API_COMMAND_SHORT_DESCRIPTION="query for the current job"
GSPC_API_COMMAND_LEVEL=2

. $(gspc --exec-path)/gspc-sh-setup

function usage()
{
    cat <<EOF
usage: current-job [-h|--help] [options]
EOF
}

urls=()
while true ; do
    case "$1" in
        -h|--help) usage ; exit ${GSPC_EX_OK} ;;
        --url)
            urls+=("$2")
            shift; shift
            ;;
        --) shift; break ;;
        *) break ;;
    esac
done

if [ ${#urls[@]} -eq 0 ]
then
    usage
    exit ${GSPC_EX_USAGE}
fi

for u in ${urls[@]}
do
    current_job=$(gspcnet-req       \
        -d /service/wfe/current-job \
        -b ""                       \
        --no-headers                \
        "${u}")
    if [ -n "$current_job" ]
    then
        echo "${u} -> $current_job"
    fi
done
