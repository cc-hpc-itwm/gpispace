#!/bin/bash

GSPC_API_COMMAND_SHORT_DESCRIPTION="manage the processes"
GSPC_API_COMMAND_LEVEL=1

. $(gspc --exec-path)/gspc-sh-setup

function usage()
{
    cat <<EOF
usage: ctrl [-h|--help] [options] [--] <action...>

Options:

   --url                 only work on specific url(s), otherwise work on all
                         that can be found

   --kvs-host <host>     specify the host of the KVS
   --kvs-port <port>     specify the port of the KVS

Actions:

$(gspc --no-alias list-commands --prefix=ctrl --indent=4 --level=$((GSPC_API_COMMAND_LEVEL+1)))
EOF
}

kvs_opts=()
urls=()
while true ; do
    case "$1" in
        -h|--help) usage ; exit ${GSPC_EX_OK} ;;
        --kvs-host)
            kvs_opts+=(--host="$2")
            shift ; shift
            ;;
        --kvs-port)
            kvs_opts+=(--port="$2")
            shift ; shift
            ;;
        --url)
            urls+=(--url "$2")
            shift; shift
            ;;
        --) shift; break ;;
        *) break ;;
    esac
done

action="$1"

if [ -z "$action" ] ; then
    usage
    exit ${GSPC_EX_USAGE}
else
    shift
fi

cmd=$(gspc_resolve_command "ctrl-${action}")

if [ ! -x "${cmd}" ]
then
    gspc_log_error ctrl "invalid action: ${action}"
fi

if [ ${#urls[@]} -eq 0 ]
then
    tmp_urls=( $(gspc kvs "${kvs_opts[@]}" --get-regex gspc.net.url | cut -d= -f 2) )
    for u in ${tmp_urls[@]}
    do
        urls+=(--url "$u")
    done
fi

"${cmd}" "${urls[@]}" "$@"
