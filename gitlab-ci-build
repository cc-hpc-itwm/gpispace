#!/bin/bash
myhost=$(hostname)

opts=(--with-tests)
makeflags=()
ctestflags=()

case "$myhost" in
    build-*)
        export HWLOC_HOME=/home/projects/sdpa/external_software/hwloc/1.4.2/gcc
        export QTDIR=~/external_software/qt/4.8.5
        export PATH=$QTDIR/bin:$PATH
        export BOOST_ROOT=~/external_software/boost/1.52/gcc/
        export NACL_HOME=~/external_software/nacl/20110221
        export SMC_HOME=~/external_software/smc/5.0.0
        makeflags+=(-j2)
        ;;
    voyager)
        makeflags+=(-j4)
        ;;
esac

./configure --prefix=$PWD/inst "${opts[@]}"
ec=$?
if [ $ec -ne 0 ]
then
    echo >&2 "CONFIGURE FAILED: $ec"
    exit $ec
fi

make "${makeflags[@]}"
ec=$?
if [ $ec -ne 0 ]
then
    echo >&2 "MAKE FAILED: $ec"
    exit $ec
fi

make "${makeflags[@]}" install
ec=$?
if [ $ec -ne 0 ]
then
    echo >&2 "INSTALL FAILED: $ec"
    exit $ec
fi

cd build && ctest "${ctestflags[@]}"
ec=$?
if [ $ec -ne 0 ]
then
    echo >&2 "TESTS FAILED: $ec"
    exit $ec
fi

exit 0
