<defun name="find_eureka">

  <in name="eureka_gid" type="string" place="eureka_group"/>
  <in name="token" type="unsigned long" place="token"/>

  <net>
    <place name="token" type="unsigned long"/>
    <place name="value" type="long"/>
    <place name="eureka_group" type="string"/>

    <transition name="generate_events">
      <defun>
        <in name="in" type="unsigned long"/>
        <in name="eureka_group" type="string"/>
        <out name="out" type="long"/>
        <module name="gen_eureka_with_exp" function="out generate_event(in)" eureka-group="find_small_value">
          <cinclude href="iostream"/>
          <cinclude href="stdlib.h"/>
          <cinclude href="time.h"/>
          <cinclude href="unistd.h"/>
          <!-- init random number between 1 to 30 -->
          <!-- our event (e) is 1 <= e < 20 : fix -->
          <code><![CDATA[
            srand(long(time(NULL)) ^ in);
            long value = rand() % 30 + 1;
            std::cout << "Eureka-or-not! [in = " << in << " event=" << value << "]\n";

            if (value >= 20)
            {
              sleep(5);
            }

            return value;

          ]]></code>
        </module>
      </defun>
      <connect-in port="in" place="token"/>
      <connect-out port="out" place="value"/>
      <connect-read port="eureka_group" place="eureka_group"/>
    </transition>

    <transition name="got_an_event_eureka">
      <defun>
        <in name="in" type="long"/>
        <in name="eureka_group" type="string"/>
        <out name="eureka_good" type="set"/> <!-- you eureka, then you are here" -->
        <expression>
          ${eureka_good} := set_insert (Set{}, ${eureka_group})
        </expression>
        <condition>${in} :lt: 20L</condition>
      </defun>
      <connect-in port="in" place="value"/>
      <connect-in port="eureka_group" place="eureka_group"/>
      <connect-eureka port="eureka_good"/>   <!-- eureka!! -->
    </transition>

    <transition name="no_event_eureka">
      <defun>
        <in name="in" type="long"/>
        <expression/>
        <condition>${in} :ge: 20L</condition>
      </defun>
      <connect-in port="in" place="value"/>
    </transition>
  </net>

</defun>
