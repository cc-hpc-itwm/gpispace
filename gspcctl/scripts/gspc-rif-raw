#!/bin/bash

GSPC_API_COMMAND_SHORT_DESCRIPTION="communicate with the RIF"
GSPC_API_COMMAND_LEVEL=2

. "${GSPC_EXEC_PATH}/gspc-sh-setup" || { echo >&2 "must be run by 'gspc'" ; exit 64; }

function usage()
{
    cat <<EOF
usage: rif-eval [-h|--help] [options]

Options:

   --rif-port <port>     specify the rif-port to use

   -F|--file file        use nodes from file
   -N|--node node        use this node

   --fanout N            how many parallel tasks
   --sync                synonym for --fanout 1
EOF
}

fanout=1
tmpnodes=()

while true ; do
    case "$1" in
        -h|--help) usage ; exit ${GSPC_EX_OK} ;;
        --rif-port)
            rif_port="$2"
            shift ; shift
            ;;
        -F|--file)
            f="$2"
            for n in $(cat "$f" 2>/dev/null | grep -v '^#' | sed -e '/^$/d' | sort | uniq)
            do
                tmpnodes+=($n)
            done
            shift; shift
            ;;
        -N|--node)
            n="$2"
            tmpnodes+=($n)
            shift; shift
            ;;
        --fanout)
            fanout="$2"
            shift; shift
            ;;
        --sync)
            fanout=1
            shift
            ;;
        --) shift; break ;;
        *) break ;;
    esac
done

if [ ${#tmpnodes[@]} -eq 0 -a -n "${PBS_NODEFILE}" ]
then
    for n in $(cat "$PBS_NODEFILE" 2>/dev/null | grep -v '^#' | sed -e '/^$/d' | sort | uniq)
    do
        tmpnodes+=($n)
    done
fi

nodes=()
for n in $(echo "${tmpnodes[@]}" | tr ' ' '\n' | sort | uniq)
do
    nodes+=($n)
done

if [ ${#nodes[@]} -eq 0 ]
then
    gspc_log_error rif "at least one node is required"
    exit ${GSPC_EX_USAGE}
fi

cmd=("$(gspc --bin-path)/gspcnet-req")
cmd+=(-d /service/rif)
cmd+=(--no-header)

count=0
for n in "${nodes[@]}"
do
    if [ $count -ge $fanout ]
    then
        wait
        count=0
    fi
    echo "${@}" | "${cmd[@]}" "tcp://${n}:${rif_port}" &
    count=$((count + 1))
done
if [ $count -gt 0 ]
then
    wait
    count=0
fi
