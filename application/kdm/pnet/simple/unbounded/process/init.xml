<defun>
  <in name="volume" type="VOLUME"  place="volume_in"/>
  <in name="config" type="CONFIG" place="config"/>
  <out name="bunch" type="BUNCH" place="bunch"/>
  <tunnel name="credit_load" type="control" place="credit_load"/>

  <net>
    <place name="volume_in" type="VOLUME" />
    <place name="volume_initialized" type="VOLUME" />
    <place name="volume_gen_bunch" type="VOLUME" />
    <place name="config" type="CONFIG" />

    <transition name="init_volume">
      <defun>
        <in name="volume" type="VOLUME" />
        <in name="config" type="CONFIG" />
        <out name="volume" type="VOLUME" />
        <module name="kdm" function="init_volume (config, volume)" />
      </defun>
      <connect-in place="volume_in" port="volume" />
      <connect-read place="config" port="config" />
      <connect-out place="volume_initialized" port="volume" />
    </transition>

    <transition name="extract_bunches_per_offset">
      <defun>
        <in name="volume"  type="VOLUME" />
        <in name="config"   type="CONFIG" />
        <out name="volume" type="VOLUME" />
        <out name="value"   type="long"  />
        <expression>
          ${value} := ${config.BUNCHES_PER_OFFSET};
        </expression>
      </defun>
      <connect-in place="volume_initialized" port="volume" />
      <connect-in place="config"                             port="config" />
      <connect-out place="bunches_per_offset"                 port="value" />
      <connect-out place="volume_gen_bunch"                   port="volume" />
    </transition>
    <place name="bunches_per_offset" type="long"/>

    <transition name="generate_bunch" inline="true">
      <include-function href="../generate_bunch.xml"/>
      <connect-in place="volume_gen_bunch" port="volume" />
      <connect-in place="bunches_per_offset" port="amount" />
      <connect-out place="bunch_generated" port="out" />
    </transition>

    <place name="bunch_generated" type="BUNCH"/>

    <include-template href="trigger_if.xml"/>
    <specialize name="trigger_if_BUNCH" use="trigger_if">
      <type-map replace="T" with="BUNCH"/>
    </specialize>

    <transition name="trigger_load">
      <use name="trigger_if_BUNCH"/>
      <connect-in place="credit_load"  port="trigger" />
      <connect-in place="bunch_generated" port="object"/>
      <connect-out place="bunch" port="object"/>
    </transition>

    <place name="credit_load" type="control" virtual="true"/>
    <place name="bunch" type="BUNCH"/>

  </net>
</defun>
