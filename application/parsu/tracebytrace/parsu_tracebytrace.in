#!/bin/bash

tracebytrace_dir="@PARSU_TRACEBYTRACE_DIR@"

tmp_dir=${PARSU_TMP_DIR:-${TMPDIR}}

if [ ! \( -d "${tmp_dir}" -a -w "${tmp_dir}" \) ] ; then
  echo "E: no (writeable) temp dir given (is: \"${tmp_dir}\")"
  echo "set PARSU_TMP_DIR or TMPDIR"
  exit 1
fi

scratch_dir="$HOME/.sdpa/scratch"
test ! -d "${scratch_dir}" && { mkdir -p "${scratch_dir}" ; }

xml_file_in="${tracebytrace_dir}/tracebytrace.xml.in"
mk_xml="${tracebytrace_dir}/mk.xml"

skipped_traces_default=0

shmem_per_node_default=$((2**28))
gpi_mem_per_node_default=$((2**30))

if [ $# -lt 5 ]; then
  echo "usage: $0 input-file input-type output-file output-type \"su cmd\" [skipped-traces:${skipped_traces_default}] [shmem-per-node:${shmem_per_node_default}] [gpi-mem-per-node:${gpi_mem_per_node_default}]"
  exit 1
fi

inf=${1}
int=${2}
outf=${3}
outt=${4}
cmd=${5}
skipped_traces=${6:-${skipped_traces_default}}
shmem_per_node=${7:-${shmem_per_node_default}}
gpi_mem_per_node=${8:-${gpi_mem_per_node_default}}

if [ ! -r "$inf" ] ; then
  echo "E: cannot access $inf for reading, aborting" >/dev/stderr
  exit 1
fi

if [ -e "$outf" ] ; then
    echo "W: deleting old output file" >/dev/stderr
    rm "$outf"
fi

cleanup ()
{
    test -e "${xml_file}"  && rm -f "${xml_file}"
    test -e "${pnet_file}" && rm -f "${pnet_file}"
    test -e "${script_file}" && rm -f "${script_file}"
}
trap cleanup EXIT

xml_file=$( mktemp "${tmp_dir}/parsu_tracebytrace.xml.XXXXXX" )
if [ $? -ne 0 ] ; then
  echo "could not create temporary file in ${tmp_dir}" >/dev/stderr
  exit 2
fi

pnet_file=$( mktemp "${tmp_dir}/parsu_tracebytrace.pnet.XXXXXX" )
if [ $? -ne 0 ] ; then
  echo "could not create temporary file in ${tmp_dir}" >/dev/stderr
  exit 2
fi

script_file=$( mktemp "${scratch_dir}/parsu_tracebytrace.sh.XXXXXX" )
if [ $? -ne 0 ] ; then
    echo "could not create temporary script in ${scratch_dir}" >&2
    exit 2
fi
chmod +x "${script_file}"

abspath ()
{
  p="$1"
  case "$p" in
	/*)
	  REPLY="$p"
	  ;;
	*)
	  REPLY="`pwd`/$p"
	  ;;
  esac
  return 0
}

abspath ${inf}
abs_inf="$REPLY"

abspath ${outf}
abs_outf="$REPLY"

echo "-: generating command script..." >&2
cat > "$script_file" <<EOF
#!/bin/sh
exec $cmd
EOF

echo -n "-: generating job description..." >/dev/stderr

cat "${xml_file_in}" | ${mk_xml}             \
                       "${abs_inf}"          \
                       "${int}"              \
                       "${abs_outf}"         \
                       "${outt}"             \
                       "${script_file}"      \
                       "${skipped_traces}"   \
                       "${shmem_per_node}"   \
                       "${gpi_mem_per_node}" \
                       "--BUILD--"           \
                     > "${xml_file}"

if [ $? -ne 0 ] ; then
  echo "E: generating failed!" >/dev/stderr
  exit 2
fi
echo "ok" >/dev/stderr

PARSU_PNETC_LIB_DIR="${tracebytrace_dir} -I @PARSU_PNETC_LIB_DIR@" \
parsu_run "${xml_file}" "${pnet_file}"
