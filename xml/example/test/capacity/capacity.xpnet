<defun name="capacity">

  <in name="n" type="long" place="n"/>
  <in name="sa" type="long" place="sa"/>
  <in name="sb" type="long" place="sb"/>
  <out name="r" type="long" place="r"/>

  <net>

    <place name="n" type="long"/>
    <place name="sa" type="long"/>
    <place name="sb" type="long"/>
    <place name="r" type="long"/>

    <defun name="wait">
      <in name="d" type="string"/>
      <in name="s" type="long"/>
      <inout name="k" type="long"/>
      <module name="capacity" function="wait (d, s, k)">
        <cinclude href="fhglog/fhglog.hpp"/>
        <code><![CDATA[
          LOG (INFO, d << "-" << k << ": sleeping for " << s << " seconds");

          sleep (s);
        ]]></code>
      </module>
    </defun>

    <transition name="generate" inline="true">
      <include-function href="sequence.xml"/>
      <connect-in port="amount" place="n"/>
      <connect-out port="out" place="a"/>
    </transition>

    <place name="a" type="long"/>
    <place name="b" type="long"/>
    <place name="credit_b" type="control">
      <token><value>[]</value></token>
    </place>

    <place name="wa" type="string">
      <token><value>"WAIT-A"</value></token>
    </place>
    <place name="wb" type="string">
      <token><value>"WAIT-B"</value></token>
    </place>

    <place name="a_in" type="long"/>
    <transition name="select_a">
      <defun>
        <inout name="a" type="long"/>
        <in name="credit" type="control"/>
        <expression/>
      </defun>
      <connect-in port="a" place="a"/>
      <connect-out port="a" place="a_in"/>
      <connect-in port="credit" place="credit_b"/>
    </transition>

    <transition name="waita">
      <use name="wait"/>
      <connect-read port="d" place="wa"/>
      <connect-read port="s" place="sa"/>
      <connect-in port="k" place="a_in"/>
      <connect-out port="k" place="b"/>
    </transition>

    <transition name="waitb">
      <use name="wait"/>
      <connect-read port="d" place="wb"/>
      <connect-read port="s" place="sb"/>
      <connect-in port="k" place="b"/>
      <connect-out port="k" place="r_out"/>
    </transition>

    <place name="r_out" type="long"/>

    <transition name="credit_back">
      <defun>
        <inout name="r" type="long"/>
        <out name="credit" type="control"/>
        <expression>
          ${credit} := []
        </expression>
      </defun>
      <connect-in port="r" place="r_out"/>
      <connect-out port="r" place="r"/>
      <connect-out port="credit" place="credit_b"/>
    </transition>

  </net>

</defun>
