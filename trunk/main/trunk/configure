#!/bin/bash
if [ -e ./CMakeLists.txt ] ; then
  echo "F: This script is intended to be executed in a build directory!"
  exit 1
fi

src=$( cd $( dirname "$0" ) && pwd )

function usage ()
{
    echo "$0 [-h] [-d] [-a|-A] [-t|-T] [-s|-S] [-g|-G] [-r version] [-p prefix]" >&2
    echo "   -h  : print help" >&2
    echo "   -d  : debug build" >&2
    echo "   -aA : build apps (a:yes A:no)" >&2
    echo "   -tT : build tests (t:yes T:no)" >&2
    echo "   -sS : build static (s:yes S:no)" >&2
    echo "   -gG : build gpi (g:yes G:no)" >&2
    echo "   -r  : explicitly set revision" >&2
    echo "   -p  : install prefix" >&2
}

build_debug=false
build_tests=false
build_static=false
build_apps=true
build_gpi=true
build_rev=
build_prefix=

function get_cmake_cache_entry ()
{
    cache_entry="$1"
    variable="$2"

    result=$( grep "$cache_entry" CMakeCache.txt 2>/dev/null | cut -d= -f 2 )
    if [ $? -eq 0 -a -n "$result" ] ; then
	case "$result" in
	    ON)
		result="true"
		;;
	    OFF)
		result="false"
		;;
	    *)
		;;
	esac
	eval "$variable=$result"
	return 0
    else
	return 1
    fi
}

# initialize from CMakeCache.txt
if [ -r "CMakeCache.txt" ] ; then
    get_cmake_cache_entry CMAKE_HOME_DIRECTORY src
    get_cmake_cache_entry BUILD_TESTING build_tests
    get_cmake_cache_entry BUILD_STATIC_BINARIES build_static
    get_cmake_cache_entry ENABLE_APPLICATION build_apps
    get_cmake_cache_entry ENABLE_GPI_SPACE build_gpi
    get_cmake_cache_entry CMAKE_INSTALL_PREFIX build_prefix
fi

count=0
while getopts ":hdtTsSaAgGr:p:" opt; do
    case $opt in
	h)
	    usage
	    exit 0
	    ;;
	d)
	    count=$(( count + 1 ))
	    build_debug=true
	    ;;
	a)
	    count=$(( count + 1 ))
	    build_apps=true
	    ;;
	A)
	    count=$(( count + 1 ))
	    build_apps=false
	    ;;
	t)
	    count=$(( count + 1 ))
	    build_tests=true
	    ;;
	T)
	    count=$(( count + 1 ))
	    build_tests=false
	    ;;
	s)
	    count=$(( count + 1 ))
	    build_static=true
	    ;;
	S)
	    count=$(( count + 1 ))
	    build_static=false
	    ;;
	g)
	    count=$(( count + 1 ))
	    build_gpi=true
	    ;;
	G)
	    count=$(( count + 1 ))
	    build_gpi=false
	    ;;
	r)
	    count=$(( count + 2 ))
	    build_rev="$OPTARG"
	    ;;
	p)
	    count=$(( count + 2 ))
	    build_prefix="$OPTARG"
	    ;;
	\?)
	    echo "invalid option: -$OPTARG" >&2
	    echo "try: $0 -h" >&2
	    exit 1
	    ;;
    esac
done
shift $count

if [ -z "$build_rev" ] ; then
    build_rev=$( cd "$src" && git describe --tags 2>/dev/null )
    if [ $? != 0 ]; then
	echo "W: could not get version information from git, trying svn..."
	build_rev="$( cd "$src" && svn info | grep '^Revision:' | cut -d' ' -f 2 )"
	if [ $? != 0 ]; then
	    if [ -z "$REV" ] ; then
		echo "E: could not figure out which version identification to use, aborting"
		exit 2
	    else
		echo "I: using revision information from environment \$REV: $REV"
		build_rev="$REV"
	    fi
	fi
    fi
fi

cmake_flags=
if [ -n "$build_rev" ] ; then
    build_rev=$( echo $build_rev | sed -e 's/^v//' )
    cmake_flags="$cmake_flags -DPROJECT_REVISION=$build_rev"
fi

if [ "$build_debug" == "true" ] ; then
    cmake_flags="$cmake_flags -DCMAKE_BUILD_TYPE=Debug"
else
    cmake_flags="$cmake_flags -DCMAKE_BUILD_TYPE=Release"
fi

if [ "$build_tests" == "true" ] ; then
    cmake_flags="$cmake_flags -DBUILD_TESTING=ON"
else
    cmake_flags="$cmake_flags -DBUILD_TESTING=OFF"
fi

if [ "$build_static" == "true" ] ; then
    cmake_flags="$cmake_flags -DBUILD_STATIC_BINARIES=ON"
else
    cmake_flags="$cmake_flags -DBUILD_STATIC_BINARIES=OFF"
fi

if [ "$build_apps" == "true" ] ; then
    cmake_flags="$cmake_flags -DENABLE_APPLICATION=ON"
else
    cmake_flags="$cmake_flags -DENABLE_APPLICATION=OFF"
fi

if [ "$build_gpi" == "true" ] ; then
    cmake_flags="$cmake_flags -DENABLE_GPI_SPACE=ON"
else
    cmake_flags="$cmake_flags -DENABLE_GPI_SPACE=OFF"
fi

if [ -z "$build_prefix" ] ; then
    build_prefix=$( grep CMAKE_INSTALL_PREFIX ./CMakeCache.txt | cut -d= -f 2 | tr -d \" 2>&1 )
fi
if [ -n "$build_prefix" ] ; then
    cmake_flags="$cmake_flags -DCMAKE_INSTALL_PREFIX=$build_prefix"
fi

cmake_flags="$cmake_flags $@"

cmd="cmake \"$src\" $cmake_flags"
echo "# configuring build tree"
echo "# ======================"
echo "#"
echo "#   revision: $build_rev"
echo "#     prefix: $build_prefix"
echo "#     source: $src"
echo "#      build: `pwd`"
echo "#"
echo "#      debug: $build_debug"
echo "#      tests: $build_tests"
echo "#       apps: $build_apps"
echo "#     static: $build_static"
echo "#"
echo "# cmake \"$src\" $cmake_flags"
read -t 10 -n 1 -p "press any key to continue (Ctrl+C to abort)..."
echo
cmake "$src" $cmake_flags
