#!/bin/bash

if [ -r ~/.init-screen.env ]; then
    source ~/.init-screen.env
fi

debug=false
bind_addr="`hostname`"
name="nre-`hostname -s`"
agg="aggregator"

gui_url="$SDPA_GUI"
if [ -z "$gui_url" ]
then
  gui_url="lts019.itwm.fhg.de:9001"
fi

if [ -z "$SDPA_LOG_DIR" ] ; then
  echo "# SDPA_LOG_DIR is not set!"
  exit 1
fi

if [ ! -w "$SDPA_LOG_DIR" ] ; then
  echo "# SDPA_LOG_DIR=\"$SDPA_LOG_DIR\" is not writable!"
  exit 1
fi

rank=0
if [ -n "$1" ]; then
  rank=$1
fi

gpi_cfg=
if [ -n "$SDPA_GPI_CFG" -a -r "$SDPA_GPI_CFG" ] ; then
  gpi_cfg="$SDPA_GPI_CFG"
elif [ -r "$HOME/.sdpa/configs/gpi.rc" ] ; then
  gpi_cfg="$HOME/.sdpa/configs/gpi.rc"
elif [ -n "$SDPA_GPI_CFG" -a -r "$SDPA_HOME/etc/gpi/sdpa-gpi.cfg" ] ; then
  gpi_cfg="$SDPA_HOME/etc/gpi/sdpa-gpi.cfg"
else
  echo "# could not figure out, which config file to use!"
  echo "#    the following might help:"
  echo "#"
  echo "#       set SDPA_GPI_CFG (current: $SDPA_GPI_CFG)"
  echo "#       create \$HOME/.sdpa/configs/gpi.rc"
  echo "#       create \$SDPA_HOME/etc/gpi/sdpa-gpi.cfg"
  exit 1
fi

while read k v; do
    case "$k" in
	SHMSZ)
	    log "using shmsz $v"
	    export FVM_PC_SHMSZ="$v"
	    ;;
	FVMSZ)
	    log "using fvmsz $v"
	    export FVM_PC_FVMSZ="$v"
	    ;;
	MSQFILE)
	    log "using msq $v"
	    export FVM_PC_MSQ="$v"
	    ;;
	SHMFILE)
	    log "using shm $v"
	    export FVM_PC_SHM="$v"
	    ;;
    esac
done < "$gpi_cfg"

log "killing process-container..."
killall nre-pcd >/dev/null 2>&1
sleep 1
log "killing old nre..."
killall nre >/dev/null 2>&1
sleep 1

log "Running $name with rank $rank at $bind_addr with parent $agg"
FHGLOG_to_file="$SDPA_LOG_DIR/pc.`hostname`.log" nre-pcd \
    --rank "$rank" \
    --load "$SDPA_LIBEXEC/libfvm-pc.so" \
    --load "$SDPA_LIBEXEC/libsinc.so" \
    -a "$SDPA_LIBEXEC" &

sleep 1

FHGLOG_to_file="$SDPA_LOG_DIR/nre.`hostname`.log" nre \
    --url "${bind_addr}" \
    --name "${name}" \
    --gui_url="$gui_url" \
    --agg_name="$agg" &
