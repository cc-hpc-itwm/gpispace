#!/bin/sh

if [ -r ~/.init-screen.env ]; then
    source ~/.init-screen.env
fi

debug=false
#url="0.0.0.0:5001"
bind_addr="`hostname`"
name="aggregator"
orch="orchestrator"

while getopts ":hgo:l:n:" opt; do
  case $opt in
	o)
	  orch=$OPTARG
	;;
	g)
	  debug=true
	;;
	l)
	  bind_addr=$OPTARG
	;;
        n)
          name=$OPTARG
        ;;
	h)
	  echo "usage: $0 [-h] [-g] [-l interface] [-o orch] [-n name]" >&2
	  echo "    -h : print this help" >&2
	  echo "    -l : url to listen on (default: $bind_addr)" >&2
	  echo "    -o : orchestrator (default: $orch)" >&2
	  echo "    -g : run within gdb" >&2
	  exit 0
	;;
	\?)
	  echo "Invalid option: -$OPTARG" >&2
	  exit 1
  esac
done

log "Running $name at $bind_addr with parent $orch"

if $debug ; then
  log "running within gdb..."
  gdb -ex run --args aggregator -n "${name}" -m "${orch}" -u "${bind_addr}" -k "${KVS_URL}"
else
  FHGLOG_to_file="$SDPA_LOG_DIR/agg.`hostname -s`.log" exec aggregator -n "${name}" -m "${orch}" -u "${bind_addr}" -k "${KVS_URL}"
fi
