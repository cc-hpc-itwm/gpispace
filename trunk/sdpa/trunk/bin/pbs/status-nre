#!/bin/sh

source ~/.init-screen.env

if [ ! -r "$SDPA_NODEFILE" ]; then
    log "I cannot access the nodefile: $SDPA_NODEFILE"
    exit 2
fi

node_max=$( uniq $SDPA_NODEFILE | wc -l )
nodes=$( echo $( seq 1 $node_max ) )
if [ $# -lt 1 ]; then
  echo "checking all NREs..."
else
  nodes=$@
fi

ec=0
for node_num in $nodes; do
  if [ $node_num -lt 1 -o $node_num -gt "$node_max" ]; then
	echo "W: ignoring node number $node_num: out of range: must be within [1,$node_max]"
	continue
  fi

  nre_ec=0
  node_name=$( uniq $SDPA_NODEFILE | tail -n +$node_num | head -n 1 )
  echo -n "checking status of nre on $node_name..."
  echo ps aux | ssh -x $node_name | grep -q '[n]re-pc' >/dev/null 2>&1
  if [ $? -eq 0 ]; then
	echo -n " nre-pc"
  else
	nre_ec=$(( nre_ec + 1 ))
  fi
  echo ps aux | ssh -x $node_name | grep -q '[n]re --url' >/dev/null 2>&1
  if [ $? -eq 0 ]; then
	echo -n " nre"
  else
	nre_ec=$(( nre_ec + 1 ))
  fi
  if [ $nre_ec != 0 ]; then
	echo " nok."
  else
	echo " ok."
  fi

  ec=$(( ec + nre_ec ))
done
exit $ec
