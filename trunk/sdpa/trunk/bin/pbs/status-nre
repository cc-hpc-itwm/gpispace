#!/bin/sh

if [ ! -r "$PBS_NODEFILE" ]; then
  echo "E: must be run on head node"
  exit 123
fi

node_max=$( uniq $PBS_NODEFILE | wc -l )
nodes=$( echo $( seq 1 $node_max ) )
if [ $# -lt 1 ]; then
  echo "checking all NREs..."
else
  nodes=$@
fi

ec=0
for node_num in $nodes; do
  if [ $node_num -lt 1 -o $node_num -gt "$node_max" ]; then
	echo "W: ignoring node number $node_num: out of range: must be within [1,$node_max]"
	continue
  fi

  node_name=$( uniq $PBS_NODEFILE | sort -n | tail -n +$node_num | head -n 1 )
  echo -n "checking status of nre on $node_name..."
  ssh $node_name ps aux | grep -q [n]re-pc >/dev/null 2>&1
  if [ $? -eq 0 ]; then
	echo "ok."
  else
	echo "down."
	ec=$(( ec + 1 ))
  fi
done
exit $ec
