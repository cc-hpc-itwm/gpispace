#!/bin/bash

test -r "$HOME/.sdpa/state/sdpa.env" && source "$HOME/.sdpa/state/sdpa.env"

#usage: agent [options] ....
#Allowed options:
#  -h [ --help ]                         Display this message
#  -n [ --name ] arg (=agent)            Agent's logical name
#  -u [ --url ] arg (=localhost)         Agent's url
#  -m [ --master ] arg                   Agent's master list
#  -d [ --backup_folder ] arg            Agent's backup folder
#  -f [ --backup_file ] arg              Agent's backup file (stored into the
#                                        backup folder)
#  -a [ --app_gui_url ] arg (=127.0.0.1:9000)
#                                        application GUI's url
#  -k [ --kvs_url ] arg                  The kvs daemon's url
#  --request-mode arg (=false)           send periodical job requests to master

# set some default values
gui="$SDPA_GUI"
if [ -z "$gui" ]
then
  gui="$(fhgcfg -f ~/.sdpa/configs/sdpa.rc -g sdpa.gui)"
fi

kvs_url="$KVS_URL"
debug=false
daemonize=false
bind_addr='0'
name=
master=
force=false
logfile="$SDPA_LOG_DIR/${name}.log"
backlog=1000
bin=$(which agent 2>/dev/null)
if [ -z "$bin" ] ; then
    log "# could not find agent binary in the path!"
    exit 1
fi

function usage ()
{
    cat >&2 <<EOF
usage: $(basename "$0") [options]

    -h: print this help
    -f: force: kill still running processes
    -d: debug mode
    -n name (*): name of this agent
    -m master (*): master to connect to
    -g ip:port (=$gui): gui address
    -b N (=$backlog): set the backlog size
    -k kvs-url (=$kvs_url): url to the key-value-store
    -D daemonize
    -L logfile (=$logfile)
EOF
}

while getopts ":hDfdm:g:b:n:k:L:" opt; do
    case $opt in
	h)
	    usage
	    exit 0
	    ;;
	f)
	    force=true
	    ;;
	d)
	    debug=true
	    ;;
        n)
            name=$OPTARG
            ;;
	m)
	    master=$OPTARG
	    ;;
	g)
	    gui=$OPTARG
	    ;;
	b)
	    backlog=$OPTARG
	    ;;
	k)
	    kvs_url=$OPTARG
	    ;;
	D)
	    daemonize=true
	    ;;
	L)
	    logfile=$OPTARG
	    ;;
	\?)
	    echo "Invalid option: -$OPTARG" >&2
	    exit 1
    esac
done

if [ -z "$name" -o -z "$master" ] ; then
    echo "E: I need both, a name and a master!" 2>&1
    usage
    exit 1
fi

function agent_status ()
{
    local name="$1" ; shift
    local pids=$(ps aux | grep -v [s]tart-agent | grep "[a]gent.*-n \<$name\>" | awk '{print $2;}')
    if [ -z "$pids" ] ; then
	return 1
    else
	echo $pids
	return 0
    fi
}

pids=$(agent_status $name)
if [ $? -eq 0 ] ; then
    if [ $force == true ] ; then
	kill -TERM $pids
	sleep 1.5
	kill -KILL $pids &>/dev/null
    else
	echo "E: agent $name still running with pid(s): $pids" >&2
	exit 1
    fi
fi

opts="$opts -n ${name} "
opts="$opts -u ${bind_addr}"
opts="$opts -m ${master}"
opts="$opts -k ${kvs_url}"

stateful="$(fhgcfg -f ~/.sdpa/configs/sdpa.rc -g sdpa.stateful -v false)"
if [ x"$stateful" = x"true" ] ; then
    opts="$opts -d ${SDPA_SCRATCH_DIR}/state"
fi

cmd="${bin} $opts"

log "Running $name on $(hostname -s) with master $master"

if $debug ; then
    log "running within gdb..."
    gdb -ex run --args ${cmd}
else
    if $daemonize ; then
	FHGLOG_to_console=stderr FHGLOG_to_file="$SDPA_LOG_DIR/${name}.log" exec ${cmd} </dev/null >/dev/null 2>&1 &
    else
	FHGLOG_to_console=stderr FHGLOG_to_file="$SDPA_LOG_DIR/${name}.log" exec ${cmd}
    fi
fi
