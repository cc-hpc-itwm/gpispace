#!/bin/sh

ps aux | grep -q [f]vm_sdpa_standalone
if [ $? -eq 0 ]; then
  echo "E: FVM still running, please terminate it before!"
  exit 1
fi

# gather all message queue zombies
msgq=$( echo $( pbsdsh -u -o -s ipcs -q | grep ^0x | awk '{print $2;}' | sort -u ) )
echo "message queues: $msgq"
sema=$( echo $( pbsdsh -u -o -s ipcs -s | grep ^0x | awk '{print $2;}' | sort -u ) )
echo "semaphores: $sema"
shms=$( echo $( pbsdsh -u -o -s ipcs -m | grep ^0x | awk '{print $2;}' | sort -u ) )
echo "shared mems: $shms"

pbsdsh -u pkill sdpa-gpi
for q in $msgq; do
  pbsdsh -u ipcrm -q $q
done
for s in $sema; do
  pbsdsh -u ipcrm -s $s
done
for m in $shms; do
  pbsdsh -u ipcrm -m $m
done
