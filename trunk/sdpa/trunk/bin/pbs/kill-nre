#!/bin/sh
if [ ! -r "$PBS_NODEFILE" ]; then
  echo "E: must be run on head node"
  exit 2
fi

node_max=$( uniq $PBS_NODEFILE | wc -l )
nodes=$( echo $( seq 1 $node_max ) )
if [ $# -lt 1 ]; then
  echo "killing all NREs..."
else
  nodes=$@
fi

bunch_size=16
count=0
for node_num in $nodes; do
  if [ $node_num -lt 1 -o $node_num -gt "$node_max" ]; then
	echo "W: ignoring node number $node_num: out of range: must be within [1,$node_max]"
  fi

  count=$(( count + 1 ))

  node_name=$( uniq $PBS_NODEFILE | tail -n +$node_num | head -n 1 )
  echo "killing nre on $node_name..."
  ssh -x $node_name killall nre-pcd >/dev/null 2>&1 &
  ssh -x $node_name killall nre >/dev/null 2>&1 &
  if [ $count -gt $bunch_size ] ; then
      wait
      count=0
  fi
done
wait
