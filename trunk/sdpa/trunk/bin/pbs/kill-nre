#!/bin/bash

source ~/.init-screen.env

if [ ! -r "$SDPA_NODEFILE" ]; then
    log "Cannot access nodefile: $SDPA_NODEFILE"
    exit 2
fi

node_max=$( uniq $SDPA_NODEFILE | wc -l )
nodes=$( echo $( seq 1 $node_max ) )
if [ $# -lt 1 ]; then
    log "killing all NREs..."
else
  nodes=$@
fi

bunch_size=16
count=0
for node_num in $nodes; do
  if [ $node_num -lt 1 -o $node_num -gt "$node_max" ]; then
	echo "W: ignoring node number $node_num: out of range: must be within [1,$node_max]"
  fi

  count=$(( count + 1 ))

  node_name=$( uniq $SDPA_NODEFILE | tail -n +$node_num | head -n 1 )
  log "killing nre on $node_name..."
  echo killall -w nre-pcd | ssh -T -x $node_name >/dev/null 2>&1 &
  echo killall -w nre | ssh -T -x $node_name >/dev/null 2>&1 &
  if [ $count -ge $bunch_size ] ; then
      wait
      count=0
  fi
done
wait
