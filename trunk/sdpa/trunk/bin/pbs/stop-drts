#!/bin/bash
### avoid strange behaviour with temporary inconsistency
### on Panasas Filesystems:
###
###     the test -r was sucessful but the source didn't
###     source anything
###
###
cat "~/.sdpa/state/sdpa.env" >/dev/null 2>&1

test -r "~/.sdpa/state/sdpa.env" && source "~/.sdpa/state/sdpa.env"

function usage ()
{
    cat >&2 <<EOF
usage: $(basename "$0") [options]

    -h: print this help
    -i ident (=$identiy): identity
    -n: dry run
EOF
}

identity=
dry_run=false

while getopts ":hi:n" opt; do
    case $opt in
	h)
	    usage
	    exit 0
	    ;;
	i)
	    identity=$OPTARG
	    ;;
	n)
	    dry_run=true
	    ;;
	\?)
	    echo "invalid option: -$OPTARG" >&2
	    echo "try: $0 -h" >&2
	    exit 1
	    ;;
    esac
done

function kill_drts ()
{
    local pid="$1" ; shift
    local name="$1" ; shift
    local alive=true
    echo -n "Terminating $pid..."
    for (( i=0; i < 3; ++i )); do
	echo -n "."
        kill -TERM "$pid" >/dev/null 2>&1
	if [ $? -ne 0 ] ; then
	    alive=false
	fi
	if [ "$alive" == "false" ] ; then
	    echo "ok."
	    return 0
	fi
	sleep 0.5
    done
    if [ "$alive" == "true" ] ; then
	echo "killed."
        kill -KILL "$pid" >/dev/null 2>&1
    fi
}

still_running=$(ps -C fhgkernel -o pid=)
for p in $still_running ; do
    name=$(cat /proc/$p/cmdline | tr '\0' ' ' |  grep -o 'plugin.drts.name=[^ ]\+' | cut -d= -f2)
    if [ -z "$name" ] ; then
	continue
    fi
    if [ -n "$identity" ] ; then
	if [ x"$name" == x"drts-$(hostname -s)-$identity" ] ; then
	    if $dry_run ; then
		echo kill_drts "$p" "$name"
	    else
		kill_drts "$p" "$name" >/dev/null 2>&1
	    fi
	fi
    else
	if $dry_run ; then
	    echo kill_drts "$p" "$name"
	else
	    kill_drts "$p" "$name" >/dev/null 2>&1
	fi
    fi
done
wait
