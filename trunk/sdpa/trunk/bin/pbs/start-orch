#!/bin/bash

test -r "$HOME/.sdpa/state/sdpa.env" && source "$HOME/.sdpa/state/sdpa.env"

debug=false
bind_addr='0'
name="orchestrator"
bkp_dir="${SDPA_SCRATCH_DIR}/state"

while getopts ":hgn:l:d:" opt; do
  case $opt in
	g)
	  debug=true
	;;
	l)
	  bind_addr=$OPTARG
	;;
        n)
          name=$OPTARG
        ;;
	b)
	  bkp_dir=$OPTARG
	;;
	h)
	  echo "usage: $0 [-h] [-g] [-l interface] [-n name] [-b backup-dir]" >&2
	  echo "    -h : print this help" >&2
	  echo "    -l : address to listen on (default: $bind_addr)" >&2
	  echo "    -n : name (default: $name)" >&2
          echo "    -b : path to the backup directory (${bkp_dir})" >&2
	  echo "    -g : run within gdb" >&2
	  exit 0
	;;
	\?)
	  echo "Invalid option: -$OPTARG" >&2
	  exit 1
  esac
done

log "Running $name at $bind_addr"

argv="-u $bind_addr -n ${name} -k ${KVS_URL}"
stateful="$(fhgcfg -f ~/.sdpa/configs/sdpa.rc -g sdpa.stateful -v false)"
if [ x"$stateful" = x"true" ] ; then
    argv="$argv -d ${bkp_dir}"
fi

if $debug ; then
  log "running within gdb..."
  FHGLOG_to_console="stderr" gdb -ex run --args orchestrator $argv
else
  FHGLOG_to_file="$SDPA_LOG_DIR/orch.`hostname -s`.log" exec orchestrator $argv
fi
