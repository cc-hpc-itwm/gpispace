#!/bin/bash
### avoid strange behaviour with temporary inconsistency
### on Panasas Filesystems:
###
###     the test -r was sucessful but the source didn't
###     source anything
###
###
cat "~/.sdpa/state/sdpa.env" >/dev/null 2>&1

test -r "~/.sdpa/state/sdpa.env" && source "~/.sdpa/state/sdpa.env"

name=

function usage ()
{
    cat >&2 <<EOF
usage: $(basename "$0") [options]

    -h: print this help
    -n name (*): name of the agent to kill (if empty all will be killed)
EOF
}

while getopts ":hn:" opt; do
    case $opt in
	h)
	    usage
	    exit 0
	    ;;
	n)
	    name=$OPTARG
	    ;;
	\?)
	    echo "Invalid option: -$OPTARG" >&2
	    exit 1
    esac
done

function agent_status ()
{
    local name="$1" ; shift
    local pids=$(ps aux | grep -v [s]top-agent | grep "[a]gent.* -n $name" | awk '{print $2;}')
    if [ -z "$pids" ] ; then
	return 1
    else
	echo $pids
	return 0
    fi
}

#if [ -z "$name" ] ; then
#    echo -n "I: terminating all agents: " >&2
#else
#    echo -n "I: terminating agent $name: "
#fi

pids=$(agent_status $name)
if [ -n "$pids" ] ; then
#    echo $pids
    kill -TERM $pids
    sleep 2
    kill -KILL $pids &>/dev/null
    if kill -0 $pids &>/dev/null ; then
	exit 1
    else
	exit 0
    fi
else
    exit 2
fi
