#!/bin/sh

source ~/.init-screen.env

if [ ! -r "$SDPA_NODEFILE" ]; then
    log "I cannot access the nodefile: $SDPA_NODEFILE"
    exit 2
fi

ps aux | grep -q "[s]dpa-gpi"
if [ $? -ne 0 ]; then
    log "W: GPI is not running, checking for fvm!"
    ps aux | grep -q "[f]vm_sdpa_standalone"
    if [ $? -ne 0 ] ; then
	log "F: FVM is not running, please start either sdpa-gpi or fvm_sdpa_standalone!"
	exit 2
    fi
fi

node_max=$( uniq $SDPA_NODEFILE | wc -l )
nodes=$( echo $( seq 1 $node_max ) )
if [ $# -lt 1 ]; then
    log "booting all NREs..."
else
    nodes=$@
fi

bunch_size=16
count=0
for node_num in $nodes; do
    if [ $node_num -lt 1 -o $node_num -gt "$node_max" ]; then
	echo "W: ignoring node number $node_num: out of range: must be within [1,$node_max]"
	continue
    fi

    count=$(( count + 1 ))

    node_name=$( uniq $SDPA_NODEFILE | tail -n +$node_num | head -n 1 )
    rm -f "$SDPA_LOG_DIR/nre.$node_name.log"
    rm -f "$SDPA_LOG_DIR/pc.$node_name.log"
    rank=$(( $node_num - 1 ))

    log "starting nre on $node_name (rank: $rank)..."

    ssh -x $node_name start-nre -r $rank >/dev/null 2>&1 &
    if [ $count -gt $bunch_size ] ; then
	wait
	count=0
    fi
done
wait
