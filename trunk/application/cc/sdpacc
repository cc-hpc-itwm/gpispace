#!/bin/bash
#
# wrapper around a compiler similar to icecream
#
#
# 1. prepare job description
#
#      take prepared pnet (or compile if not present)
#
# 2. place tokens
#      working directory
#      parameters
#      compiler to use (name)
#      build-environment + md5sum
#
# 3. submit
#
#      wait until finished
#      check exit code token
#      print stdout
#      print stderr

prog_name=$(basename $0)
compiler="$prog_name"
c_compiler="gcc"
cxx_compiler="g++"

if [ -n "$SDPACC_CC" ] ; then
    c_compiler="$SDPACC_CC"
fi
if [ -n "$SDPACC_CXX" ] ; then
    cxx_compiler="$SDPACC_CXX"
fi
if [ -z "$SDPA_HOME" ] ; then
    echo "SDPA must be be loaded and started! (SDPA_HOME is empty)" >&2
    exit 1
fi

args="$@"
pnet="$SDPA_HOME/share/sdpa/cc/compile.pnet"

pnet_tmp=$(mktemp)
jobid=

function compile ()
{
    prepare
    execute
}

function prepare ()
{
    pnetput --if "${pnet}" --of "${pnet_tmp}" \
              -p compiler=\""$compiler"\" \
              -p params=\""$args"\" \
              -p working_directory=\""$PWD"\" \
              -p build_environment=\"\"
}

function execute ()
{
    jobid=$(sdpac submit ${pnet_tmp} 2>&1)
    ec=$?
    if [ $ec -ne 0 ] ; then
	echo "submission failed: $jobid" >&2
	return $ec
    fi
    test -e "${pnet_tmp}" && rm -f "${pnet_tmp}"
    sdpac wait "$jobid" &>/dev/null
    ec=$?
    if [ $ec -ne 0 ] ; then
	return $ec
    fi
    sdpac results "${jobid}" &>/dev/null
    sdpac delete "${jobid}" &>/dev/null

    # FIXME: pnetget should be able to use port names!
    std_out=$(pnetget -i "sdpa.${jobid}.out" | grep 'on 5: ' | sed -e 's/^on 5: //g')
    std_out=$(echo $std_out | sed -e 's/\"\(.*\)/\1/')
    std_out=$(echo $std_out | sed -e 's/\(.*\)\"/\1/')
    std_err=$(pnetget -i "sdpa.${jobid}.out" | grep 'on 6:' | sed -e 's/on 6: //g')
    std_err=$(echo -n $std_err | sed -e 's/\"\(.*\)/\1/')
    std_err=$(echo -n $std_err | sed -e 's/\(.*\)\"/\1/')
    ec=$(pnetget -i "sdpa.${jobid}.out" | grep 'on 4:' | sed -e 's/on 4: //g')
    ec=$(echo $ec | tr -d L)

    test -e "sdpa.${jobid}.out" && rm -f "sdpa.${jobid}.out"

    if [ -n "$std_out" ] ; then
	echo -e "$std_out"
    fi
    if [ -n "$std_err" ] ; then
	echo -e "$std_err" >&2
    fi
    return $ec
}

case "$prog_name" in
    *cc)
	compiler="$c_compiler"
	;;
    *++)
	compiler="$cxx_compiler"
	;;
    *)
	echo "E: dunno how to behave as $prog_name" >&2
	exit 1
	;;
esac

compile $@
