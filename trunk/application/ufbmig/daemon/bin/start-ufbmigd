#!/bin/bash

# cleanup for startup via gpid.exe...
if [ x"$HOME" == x"/" ] ; then
   echo "I guess, I am running under gpid.exe..." >&2
   echo "fixing some environment variables..." >&2
   unset HOME
   export HOME=$(echo ~)
fi

test -r "$HOME/.sdpa/state/sdpa.env" && source "$HOME/.sdpa/state/sdpa.env"

node_file=
force=false
verbose=false
daemonize=false
name=ufbmigd
orchestrator=orchestrator
timeout=5 # in seconds

if [ -n "$PBS_NODEFILE" ] ; then
   node_file="$PBS_NODEFILE"
fi

function usage ()
{
    cat >&2 <<EOF
usage: $(basename $0) [options]

  -h: this help
  -f: node file to use
  -o: orchestrator to use
  -n: name of the daemon
  -v: be verbose
  -F: kills still running daemon
EOF
}

EX_OK=0
EX_USAGE=64
EX_NOINPUT=66      # cannot open input
EX_NOUSER=67       # addressee unknown
EX_NOHOST=68       # host name unknown
EX_UNAVAILABLE=69  # service unavailable
EX_SOFTWARE=70     # internal software error
EX_OSERR=71        # system error (e.g., can't fork)
EX_OSFILE=72       # critical OS file missing
EX_CANTCREAT=73    # can't create (user) output file
EX_IOERR=74        # input/output error
EX_TEMPFAIL=75     # temp failure; user is invited to retry
EX_PROTOCOL=76     # remote error in protocol
EX_NOPERM=77       # permission denied
EX_CONFIG=78       # configuration error

while getopts ":hf:o:n:vF" opt; do
    case $opt in
	h)
	    usage
	    exit 0
	    ;;
	f)
	    node_file="$OPTARG"
	    shift 2
	    ;;
	o)
	    orchestrator="$OPTARG"
	    shift 2
	    ;;
	n)
	    name="$OPTARG"
	    shift 2
	    ;;
	v)
	    verbose=true
	    shift 1
	    ;;
	F)
	    force=true
	    shift 2
	    ;;
	\?)
	    ;;
    esac
done

if [ -z "$node_file" ] ; then
    node_file=$( /bin/ls -t "/var/spool/torque/aux" | /usr/bin/head -n 1)
    if [ -z "$node_file" ] ; then
        echo "No nodefile available!" >&2
        exit $EX_OSFILE
    fi
    node_file="/var/spool/torque/aux/$node_file"
    if [ ! -r "$node_file" ] ; then
	echo "Cannot read nodefile @ $node_file" >&2
	exit $EX_IOERR
    fi
fi

export PBS_NODEFILE="$node_file"
sdpa init
sdpa start kvs
log "starting ufbmigd..."
prefix=/fhgfs/HPC/petry/build/sdpacc
FHGLOG_level=MIN $prefix/util/bin/fhgkernel \
    -s plugin.net.name="${name}" \
    -s plugin.sdpac.orchestrator="${orchestrator}" \
    -s plugin.ufbmig_front.timeout_default=${timeout} \
    $prefix/sdpa/plugin/kvs.so \
    $prefix/sdpa/plugin/net.so \
    $prefix/sdpa/plugin/sdpac.so \
    $prefix/sdpa/plugin/sdpactl.so \
    $prefix/application/ufbmig/daemon/plugin/ufbmig_back.so \
    $prefix/application/ufbmig/daemon/plugin/ufbmig_front.so \
    $@
