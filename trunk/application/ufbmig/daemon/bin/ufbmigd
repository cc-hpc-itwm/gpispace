#!/bin/bash

# cleanup for startup via gpid.exe...
if [ x"$HOME" == x"/" ] ; then
   echo "I guess, I am running under gpid.exe..." >&2
   echo "fixing some environment variables..." >&2
   unset HOME
   export HOME=$(echo ~)
fi

node_file=
force=false
verbose=false
daemonize=false
name=ufbmigd
orchestrator=orchestrator
timeout=-1 # in seconds
port=55555 # application port expected by the gui

if [ -n "$PBS_NODEFILE" ] ; then
   node_file="$PBS_NODEFILE"
fi

function usage ()
{
    cat >&2 <<EOF
usage: $(basename $0) [options]

  -h: this help
  -f: node file to use
  -o: orchestrator to use
  -n: name of the daemon
  -p: application port to use
  -v: be verbose
  -F: kills still running daemon
EOF
}

EX_OK=0
EX_USAGE=64
EX_NOINPUT=66      # cannot open input
EX_NOUSER=67       # addressee unknown
EX_NOHOST=68       # host name unknown
EX_UNAVAILABLE=69  # service unavailable
EX_SOFTWARE=70     # internal software error
EX_OSERR=71        # system error (e.g., can't fork)
EX_OSFILE=72       # critical OS file missing
EX_CANTCREAT=73    # can't create (user) output file
EX_IOERR=74        # input/output error
EX_TEMPFAIL=75     # temp failure; user is invited to retry
EX_PROTOCOL=76     # remote error in protocol
EX_NOPERM=77       # permission denied
EX_CONFIG=78       # configuration error

while getopts ":hf:o:n:p:vF" opt; do
    case $opt in
	h)
	    usage
	    exit 0
	    ;;
	f)
	    node_file="$OPTARG"
	    shift 2
	    ;;
	o)
	    orchestrator="$OPTARG"
	    shift 2
	    ;;
	n)
	    name="$OPTARG"
	    shift 2
	    ;;
	p)
	    port="$OPTARG"
	    shift 2
	    ;;
	v)
	    verbose=true
	    shift 1
	    ;;
	F)
	    force=true
	    shift 2
	    ;;
	\?)
	    ;;
    esac
done

if [ -z "$node_file" ] ; then
    aux="$HOME/.sdpa/data/aux"
    if [ -z "$aux" ] ; then
        echo "Could not locate torque spool directory!" >&2
        exit $EX_OSFILE
    fi
    node_file=$( /bin/ls -t "$aux" | /usr/bin/head -n 1)
    if [ -z "$node_file" ] ; then
        echo "No nodefile available!" >&2
        exit $EX_OSFILE
    fi
    node_file="$aux/$node_file"
    if [ ! -r "$node_file" ] ; then
	echo "Cannot read nodefile @ $node_file" >&2
	exit $EX_IOERR
    fi
fi

echo "using nodefile: $node_file" >&2

export PBS_NODEFILE="$node_file"

sdpa init
source $HOME/.sdpa/state/sdpa.env

log "starting kvs..."
sdpa start kvs

gpi_socket="$(fhgcfg -f ~/.sdpa/configs/sdpa.rc -g gpi.socket_path -v /var/tmp/gpi-space)"
gpi_socket="$gpi_socket/GPISpace-$(id -u)"
gpi_socket="$gpi_socket/$(fhgcfg -f ~/.sdpa/configs/sdpa.rc -g gpi.socket_name -v control)"

control_sdpa=0
gpi_api_used="$(fhgcfg -f ~/.sdpa/configs/sdpa.rc -g gpi.api)"
if [ x"$gpi_api_used" = x"gpi.api.real" ] ; then
	control_sdpa=1
fi

log "starting ufbmigd..."
state_dir="$SDPA_SCRATCH_DIR/state/ufbmigd"
mkdir -p "$state_dir"
prefix=${SDPA_HOME}
#FHGLOG_level=MIN FHGLOG_to_console=stderr valgrind --tool=memcheck --leak-check=full --show-reachable=yes --malloc-fill=0x0 --free-fill=0xa $prefix/bin/fhgkernel \
FHGLOG_level=MIN FHGLOG_to_console=stderr $prefix/bin/fhgkernel \
    --state "$state_dir/store/" \
    -s kernel.load.lazy=0 \
    -s plugin.net.name="${name}" \
    -s plugin.sdpac.orchestrator="${orchestrator}" \
    -s plugin.ufbmig_front.timeout_default=${timeout} \
    -s plugin.ufbmig_front.timeout_send=5 \
    -s plugin.ufbmig_front.port_server=${port} \
    -s plugin.ufbmig_front.chunk_size=16777216 \
    -s plugin.ufbmig_back.wf_init="${SDPA_LIBEXEC}/apps/ufbmig/ufbmig_init.pnet" \
    -s plugin.ufbmig_back.wf_mask="${SDPA_LIBEXEC}/apps/ufbmig/ufbmig_mask.pnet" \
    -s plugin.ufbmig_back.wf_calc="${SDPA_LIBEXEC}/apps/ufbmig/ufbmig_calc.pnet" \
    -s plugin.ufbmig_back.wf_done="${SDPA_LIBEXEC}/apps/ufbmig/ufbmig_done.pnet" \
    -s plugin.ufbmig_back.config="${state_dir}/config.token" \
    -s plugin.ufbmig_back.control_sdpa="${control_sdpa}" \
    -s plugin.ufbmig_back.chunk_size=16777216 \
    -s plugin.gpi.socket="$gpi_socket" \
    $prefix/libexec/plugins/kvs.so \
    $prefix/libexec/plugins/net.so \
    $prefix/libexec/plugins/gpi.so \
    $prefix/libexec/plugins/sdpac.so \
    $prefix/libexec/plugins/sdpactl.so \
    $prefix/libexec/plugins/progress.so \
    $prefix/libexec/plugins/ufbmig_back.so \
    $prefix/libexec/plugins/ufbmig_front.so \
    $@ >$SDPA_LOG_DIR/ufbmigd.log 2>&1 &
disown -a
sleep 5
