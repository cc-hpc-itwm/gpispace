#!/bin/bash

gpi_socket="$(fhgcfg -f ~/.sdpa/configs/sdpa.rc -g gpi.socket_path -v /var/tmp/gpi-space)"
gpi_socket="$gpi_socket/GPISpace-$(id -u)"
gpi_socket="$gpi_socket/$(fhgcfg -f ~/.sdpa/configs/sdpa.rc -g gpi.socket_name -v control)"

state_dir="/tmp/ufbmig"
mkdir -p "${state_dir}"

prefix=${SDPA_HOME}
FHGLOG_level=MIN FHGLOG_to_console=stderr fhgkernel \
    -s kernel.load.lazy=0 \
    -s plugin.net.name="${name}" \
    -s plugin.sdpac.orchestrator="${orchestrator}" \
    -s plugin.ufbmig_front.timeout_default=${timeout} \
    -s plugin.ufbmig_front.port_server=${port} \
    -s plugin.ufbmig_back.wf_init="${SDPA_LIBEXEC}/apps/ufbmig/ufbmig_init.pnet" \
    -s plugin.ufbmig_back.wf_mask="${SDPA_LIBEXEC}/apps/ufbmig/ufbmig_mask.pnet" \
    -s plugin.ufbmig_back.wf_calc="${SDPA_LIBEXEC}/apps/ufbmig/ufbmig_calc.pnet" \
    -s plugin.ufbmig_back.wf_done="${SDPA_LIBEXEC}/apps/ufbmig/ufbmig_done.pnet" \
    -s plugin.ufbmig_back.config="${state_dir}/config.token" \
    -s plugin.ufbmig_back.control_sdpa=0 \
    -s plugin.gpi.socket="$gpi_socket" \
    $prefix/libexec/plugins/kvs.so \
    $prefix/libexec/plugins/net.so \
    $prefix/libexec/plugins/gpi.so \
    $prefix/libexec/plugins/sdpac.so \
    $prefix/libexec/plugins/sdpactl.so \
    $prefix/libexec/plugins/ufbmig_back.so \
    $prefix/libexec/plugins/ufbmig_test.so
