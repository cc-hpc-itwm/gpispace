<defun name="init">
  <include-structs href="types.xml"/>

  <in name="desc" type="string" place="desc"/>
  <out name="store" type="long" place="store"/>
  <out name="part" type="long" place="part"/>
  <out name="config" type="config" place="config"/>
  <out name="wait" type="long" place="wait"/>
  <out name="write_credit" type="control" place="write_credit"/>
  <out name="load_credit" type="control" place="load_credit"/>
  <out name="num_store" type="long" place="num_store_out"/>
  <out name="num_write_credit" type="long" place="num_write_credit_out"/>
  <out name="num_load_credit" type="long" place="num_load_credit_out"/>

  <net>
    <place name="desc" type="string"/>
    <place name="store" type="long"/>
    <place name="part" type="long"/>
    <place name="config" type="config"/>
    <place name="wait" type="long"/>
    <place name="write_credit" type="control"/>
    <place name="load_credit" type="control"/>

    <place name="num_store" type="long"/>
    <place name="num_part" type="long"/>
    <place name="num_write_credit" type="long"/>
    <place name="num_load_credit" type="long"/>
    <place name="num_store_out" type="long"/>
    <place name="num_write_credit_out" type="long"/>
    <place name="num_load_credit_out" type="long"/>

    <transition name="init">
      <defun>
        <in name="desc" type="string"/>
        <out name="config" type="config"/>
        <module name="simple_process" function="init"/>
      </defun>
      <connect-in port="desc" place="desc"/>
      <connect-out port="config" place="config_initialized"/>
    </transition>
    <place name="config_initialized" type="config"/>

    <transition name="extract">
      <defun>
        <in name="config" type="config"/>
        <out name="config" type="config"/>
        <out name="num_store" type="long"/>
        <out name="num_store_out" type="long"/>
        <out name="num_part" type="long"/>
        <out name="num_write_credit" type="long"/>
        <out name="num_write_credit_out" type="long"/>
        <out name="num_load_credit" type="long"/>
        <out name="num_load_credit_out" type="long"/>
        <out name="wait" type="long"/>
        <expression>
          ${num_store} := ${config.num.store};
          ${num_store_out} := ${num_store};
          ${num_part} := ${config.num.part};
          ${num_write_credit} := ${config.num.write_credit};
          ${num_write_credit_out} := ${num_write_credit};
          ${num_load_credit} := ${config.num.load_credit};
          ${num_load_credit_out} := ${num_load_credit};
          ${wait} := ${config.num.part};
        </expression>
      </defun>
      <connect-in port="config" place="config_initialized"/>
      <connect-out port="config" place="config"/>
      <connect-out port="num_store" place="num_store"/>
      <connect-out port="num_store_out" place="num_store_out"/>
      <connect-out port="num_part" place="num_part"/>
      <connect-out port="num_write_credit" place="num_write_credit"/>
      <connect-out port="num_write_credit_out" place="num_write_credit_out"/>
      <connect-out port="num_load_credit" place="num_load_credit"/>
      <connect-out port="num_load_credit_out" place="num_load_credit_out"/>
      <connect-out port="wait" place="wait"/>
    </transition>

    <transition name="generate_store" inline="true">
      <include-function href="sequence.xml"/>
      <connect-in port="amount" place="num_store"/>
      <connect-out port="out" place="store"/>
    </transition>

    <transition name="generate_part" inline="true">
      <include-function href="sequence.xml"/>
      <connect-in port="amount" place="num_part"/>
      <connect-out port="out" place="part"/>
    </transition>

    <transition name="generate_write_credit" inline="true">
      <include-function href="sequence_control.xml"/>
      <connect-in port="amount" place="num_write_credit"/>
      <connect-out port="out" place="write_credit"/>
    </transition>

    <transition name="generate_load_credit" inline="true">
      <include-function href="sequence_control.xml"/>
      <connect-in port="amount" place="num_load_credit"/>
      <connect-out port="out" place="load_credit"/>
    </transition>
  </net>
</defun>
